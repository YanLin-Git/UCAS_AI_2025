# 桶排序

# 一、基本思想

1. 按照某种规则，将n个元素分发到k个桶里
    - 通常$k \approx n$
2. 各桶内的元素，插入排序
3. 依次联结各桶


# 二、复杂度分析

## 2.1 最差情况
试想分发之后，所有元素都放在了一个桶里...  
相当于**插入排序**，$O(n^2)$

## 2.2 平均情况

1. 整体复杂度的表达式（假设k=n）
    1. 分发阶段将n个元素分发，复杂度：$\Theta(n)$
    2. 排序阶段，第i个桶中有$n_i$个元素，插入排序的复杂度：$O(n_i^2)$
    3. 收集阶段，将k个桶联结，复杂度：$\Theta(k) = \Theta(n)$
    - 于是：
        $$
        T(n) = \Theta(n) + \sum\limits_{i=0}^{n-1} O(n_i^2)， \qquad \sum n_i=n
        $$

2. 我们需要对 $T(n)$ 求期望值：
$$
\begin{aligned}
E[T(n)] &= E \left[ \Theta(n) + \sum\limits_{i=0}^{n-1} O(n_i^2) \right] \\
&= \Theta(n) + E \left[ \sum\limits_{i=0}^{n-1} O( n_i^2 ) \right] & n为常量，这里取期望，是对后半部分的计算 \\
&\le \Theta(n) + E \left[ \sum\limits_{i=0}^{n-1} c n_i^2  \right] \\
&= \Theta(n) + \sum\limits_{i=0}^{n-1} c E[n_i^2] \\
\Longrightarrow  E[T(n)] &= \Theta(n) + \sum\limits_{i=0}^{n-1} O(E[n_i^2])
\end{aligned}
$$

3. 接下来证明这个结论：$E[n_i^2] = 2 - \frac 1 n$
    
    <details>
    <summary>详细证明过程</summary>
    
    - 定义随机变量$X_{ij}$：
        $$
        X_{ij} = 
        \begin{cases}
        1, &第j个元素被分发到第i个桶里 \\
        0,&其他
        \end{cases}
        $$
    - 那么第i个桶中的元素个数 $n_i = \sum\limits_j X_{ij}$，于是：
        $$
        \begin{aligned}
        E[n_i^2] &= E \left[ \left( \sum\limits_j X_{ij} \right)^2 \right] \\
        &= E \left[ ( X_{i1} + X_{i2} + ... + X_{in} )^2 \right] \\
        &= E \left[ \sum\limits_{j} {X_{ij}}^2 + \sum\limits_{1 \le j \le n} \sum\limits_{
            \begin{subarray}{c}
            1 \le k \le n \\
            k \ne j
            \end{subarray}
        } X_{ij} X_{ik} \right] \\
        &= \sum\limits_{j} E \left[ {X_{ij}}^2 \right] + \sum\limits_{1 \le j \le n} \sum\limits_{
            \begin{subarray}{c}
            1 \le k \le n \\
            k \ne j
            \end{subarray}
        } E \left[ X_{ij} X_{ik} \right] \\
        &= \sum\limits_{j} \frac 1 n + \sum\limits_{1 \le j \le n} \sum\limits_{
            \begin{subarray}{c}
            1 \le k \le n \\
            k \ne j
            \end{subarray}
        } \frac 1 {n^2} & 推导见下方注释 \\
        &= 1 + n(n-1) \frac 1 {n^2} \\
        &= 2 - \frac 1 n
        \end{aligned}
        $$
    > 由 $X_{ij}$ 的分布律，很容易求得 $E[{X_{ij}}^2]、E[X_{ij} X_{ik}]$
    > - $X_{ij}$ 分布律如下：
    >    |0|1|
    >    |---|---|
    >    |$1 - \frac 1 n$|$\frac 1 n$|
    > - $E[{X_{ij}}^2] = P(X_{ij} = 1) = \frac 1 n$
    > - $E[X_{ij} X_{ik}] = P(X_{ij} = 1) P(X_{ik} = 1) = \frac 1 {n^2}$
    

    </details>

4. 于是：
$$
\begin{aligned}
E[T(n)] &= \Theta(n) + \sum\limits_{i=0}^{n-1} O(E[n_i^2]) \\
&= \Theta(n) + \sum\limits_{i=0}^{n-1} O(2 - \frac 1 n) \\
&= \Theta(n) + O(n) \\
&= \Theta(n)
\end{aligned}
$$